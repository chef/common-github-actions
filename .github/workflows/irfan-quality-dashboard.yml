# runs after sonar

# sonarqube-internal-repo.yml
name: Quality reporting

on:
  workflow_call:
    # all secrets are inherited from the calling workflow, typically SONAR_TOKEN, SONAR_HOST_URL, GH_TOKEN
    inputs:
      perform-build: 
        required: false
        type: boolean
      build-profile:  # TODO: implmenet this flag - chef360 container build flags, etc
        required: false
        type: string
      language: 
        required: false
        type: string
      report-unit-test-coverage: 
        required: false
        type: boolean
      report-to-atlassian-dashboard: 
        required: false
        type: boolean
      quality-product-name:
        required: false
        type: string
      quality-sonar-app-name:
        required: false
        type: string
      quality-testing-type:
        required: false
        type: string
      quality-service-name:
        required: false
        type: string
      quality-junit-report:
        required: false
        type: string
      visibility: # TODO: simplify the sonar step by bringing in the other variants (private, public, internal) from the calling workflow
        required: false
        type: string
      go-private-modules:
        required: false
        type: string
      udf1:
        required: false
        type: string
      udf2:
        required: false
        type: string
      udf3:
        required: false
        type: string
      
jobs:
  irfan:
    runs-on: ubuntu-latest-4-cores
    permissions: 
      id-token: write
      contents: read
    steps:
#TODO: Test adding Irfan's quality reporting stage inline here after sonar run (https://github.com/Progress-I360/github-action-reporting)
# PRODUCT_NAME = [Chef360 | Courier | Inspec]
    - name: Run SonarQube report generation
      if: ${{ inputs.report-to-atlassian-dashboard == true && inputs.visibility == 'internal' }}
      uses: Progress-I360/github-action-reporting/sonarqube@main
      with:
        PRODUCT_NAME: ${{ inputs.quality-product-name }}
        SONAR_APP_NAME: ${{ inputs.quality-sonar-app-name }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

# TESTING_TYPE = [Unit | Integration | e2e | api | Performance | Security]
# ENVIRONMENT = [DEV | STAGE | PROD] (optional)
    - name: Run report generation
      if: ${{ inputs.report-to-atlassian-dashboard == true && inputs.report-unit-test-coverage == true && inputs.visibility == 'internal' }}
      uses: Progress-I360/github-action-reporting/automation@main
      with:
        PRODUCT_NAME: ${{ inputs.quality-product-name }}
        TESTING_TYPE: ${{ inputs.quality-testing-type }}
        SERVICE_NAME: ${{ inputs.quality-service-name }}
        JUNIT_REPORT: ${{ inputs.quality-junit-report }}