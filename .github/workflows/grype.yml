# grype.yml
# Grype security scan for source code vulnerabilities
# https://github.com/anchore/grype

name: Grype security scan

on:
  workflow_call:
    inputs:
      fail-grype-on-high:
        description: 'Fail the pipeline if Grype finds HIGH vulnerabilities'
        required: false
        type: boolean
        default: false
      fail-grype-on-critical:
        description: 'Fail the pipeline if Grype finds CRITICAL vulnerabilities'
        required: false
        type: boolean
        default: false

jobs:
  grype-scan:
    name: Grype vulnerability scan
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Grype
        run: |
          curl -sSfL https://get.anchore.io/grype | sh -s -- -b /usr/local/bin

      - name: Login to Amazon ECR
        id: ecr-login
        continue-on-error: false
        run: |
          aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin 448877188565.dkr.ecr.us-east-2.amazonaws.com
          echo "ecr_authenticated=true" >> $GITHUB_OUTPUT

      - name: Check for Dockerfile and build image if found
        id: docker-build
        continue-on-error: false
        run: |
          if [ -f "Dockerfile" ]; then
            echo "Dockerfile found, attempting to build Docker image..."
            if docker build -t grype-scan-image:latest .; then
              echo "scan_target=grype-scan-image:latest" >> $GITHUB_OUTPUT
              echo "scan_type=image" >> $GITHUB_OUTPUT
            else
              echo "Docker build failed, falling back to directory scan"
              echo "scan_target=." >> $GITHUB_OUTPUT
              echo "scan_type=dir" >> $GITHUB_OUTPUT
            fi
          else
            echo "No Dockerfile found, will scan source directory"
            echo "scan_target=." >> $GITHUB_OUTPUT
            echo "scan_type=dir" >> $GITHUB_OUTPUT
          fi

      - name: Run Grype scan
        id: grype-scan
        continue-on-error: true
        run: |
          SCAN_TARGET="${{ steps.docker-build.outputs.scan_target }}"
          SCAN_TYPE="${{ steps.docker-build.outputs.scan_type }}"
          SCAN_NAME="${{ github.repository }}"
          
          echo "Scan type: $SCAN_TYPE"
          echo "Scan target: $SCAN_TARGET"
          echo "Scan name: $SCAN_NAME"
          
          # Scan based on type
          if [ "$SCAN_TYPE" == "image" ]; then
            echo "Scanning Docker image..."
            grype $SCAN_TARGET --name "$SCAN_NAME" --output json > grype-scan.json 2>&1
            grype $SCAN_TARGET --name "$SCAN_NAME" --output table > grype-scan.log 2>&1 || true
          else
            echo "Scanning source directory..."
            grype dir:$SCAN_TARGET --name "$SCAN_NAME" --output json > grype-scan.json 2>&1
            grype dir:$SCAN_TARGET --name "$SCAN_NAME" --output table > grype-scan.log 2>&1 || true
          fi

      - name: Check Grype results and fail if vulnerabilities found
        if: ${{ always() && (inputs.fail-grype-on-high == true || inputs.fail-grype-on-critical == true) }}
        run: |
          JSON_FILE="grype-scan.json"
          
          if [ ! -f "$JSON_FILE" ]; then
            echo "⚠️  Grype JSON output not found"
            exit 0
          fi
          
          # Extract vulnerability counts by severity from JSON using jq
          if command -v jq &> /dev/null; then
            CRITICAL_COUNT=$(jq '[.matches[]? | select(.vulnerability.severity == "Critical")] | length' "$JSON_FILE" 2>/dev/null || echo "0")
            HIGH_COUNT=$(jq '[.matches[]? | select(.vulnerability.severity == "High")] | length' "$JSON_FILE" 2>/dev/null || echo "0")
          else
            # Fallback to grep if jq not available
            CRITICAL_COUNT=$(grep -o '"severity":"Critical"' "$JSON_FILE" | wc -l | tr -d ' ' || echo "0")
            HIGH_COUNT=$(grep -o '"severity":"High"' "$JSON_FILE" | wc -l | tr -d ' ' || echo "0")
          fi
          
          echo ""
          echo "============================================"
          echo "Grype Security Scan Summary"
          echo "============================================"
          echo "CRITICAL vulnerabilities: $CRITICAL_COUNT"
          echo "HIGH vulnerabilities: $HIGH_COUNT"
          echo "============================================"
          
          VIOLATIONS=""
          [ "${{ inputs.fail-grype-on-critical }}" == "true" ] && [ "$CRITICAL_COUNT" -gt 0 ] && VIOLATIONS="${VIOLATIONS}$CRITICAL_COUNT CRITICAL, "
          [ "${{ inputs.fail-grype-on-high }}" == "true" ] && [ "$HIGH_COUNT" -gt 0 ] && VIOLATIONS="${VIOLATIONS}$HIGH_COUNT HIGH, "
          
          if [ -n "$VIOLATIONS" ]; then
            echo ""
            echo "❌ BUILD FAILED: Found ${VIOLATIONS%, }"
            exit 1
          else
            echo ""
            echo "✅ No policy-violating vulnerabilities found"
          fi

      - name: Upload Grype scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grype-scan-results
          path: |
            grype-scan.json
            grype-scan.log
