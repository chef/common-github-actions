# grype.yml
# Grype security scan for source code vulnerabilities
# https://github.com/anchore/grype

name: Grype security scan

on:
  workflow_call:
    inputs:
      fail-grype-on-high:
        description: 'Fail the pipeline if Grype finds HIGH vulnerabilities'
        required: false
        type: boolean
        default: false
      fail-grype-on-critical:
        description: 'Fail the pipeline if Grype finds CRITICAL vulnerabilities'
        required: false
        type: boolean
        default: false

jobs:
  grype-scan:
    name: Grype vulnerability scan
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Configure git for private
        env:
          GOPRIVATE: ${{ inputs.go-private-modules }}
        run: git config --global url."https://${{ secrets.GH_TOKEN }}@github.com/".insteadOf "https://github.com/"

      - name: Install Grype
        run: |
          curl -sSfL https://get.anchore.io/grype | sh -s -- -b /usr/local/bin

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-2

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Scan with Grype
        id: grype-scan
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          SCAN_NAME="${{ github.repository }}"
          
          if [ ! -f "Dockerfile" ]; then
            echo "❌ No Dockerfile found - this workflow requires a Dockerfile to scan Docker image"
            exit 1
          fi
          
          echo "Building Docker image..."
          REPO_NAME=$(basename $(pwd))
          
          # Strategy 1: Check for build-docker.sh script (e.g., dsm-erchef)
          if [ -f "build-docker.sh" ]; then
            echo "Found build-docker.sh script - using it to build images"
            chmod +x build-docker.sh
            GITHUB_TOKEN="${{ secrets.GH_TOKEN }}" ./build-docker.sh
            
            # Detect all images built (typically repo name or repo-name-init)
            IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "^${REPO_NAME}" | grep -v "^<none>")
            
            if [ -z "$IMAGES" ]; then
              echo "⚠️ No images found with prefix ${REPO_NAME} after build-docker.sh"
              echo "Checking for any recently built images..."
              IMAGES=$(docker images --format "{{.CreatedAt}}\t{{.Repository}}:{{.Tag}}" | sort -r | head -5 | cut -f2 | grep -v "^<none>")
            fi
          # Strategy 2: Check for Makefile with compose-build target (e.g., chef-platform-user-accounts-service)
          elif [ -f "Makefile" ] && grep -q "^compose-build:" Makefile; then
            echo "Using Makefile compose-build target with GITHUB_TOKEN"
            export GITHUB_TOKEN="${{ secrets.GH_TOKEN }}"
            make compose-build
            
            echo "Detecting built images..."
            docker compose images
            
            IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "^${REPO_NAME}" | grep -v "^<none>")
            
            if [ -z "$IMAGES" ]; then
              echo "No images found with prefix ${REPO_NAME}, scanning all recent images"
              IMAGES=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "^<none>" | head -5)
            fi
          # Strategy 3: Fallback to standard docker build
          else
            echo "Using standard docker build with GITHUB_TOKEN build arg"
            docker build --build-arg GITHUB_TOKEN="${{ secrets.GH_TOKEN }}" -t "${REPO_NAME}:latest" .
            IMAGES="${REPO_NAME}:latest"
          fi
          
          if [ -z "$IMAGES" ]; then
            echo "❌ No Docker images found after build"
            exit 1
          fi
          
          echo "Found images to scan:"
          echo "$IMAGES"
          
          # Scan all images and combine results into single files
          > grype-scan.json  # Initialize empty JSON file
          > grype-scan.log   # Initialize empty log file
          
          for IMAGE_NAME in $IMAGES; do
            echo ""
            echo "Scanning Docker image: $IMAGE_NAME"
            grype "$IMAGE_NAME" --name "$SCAN_NAME-$(basename $IMAGE_NAME)" --output json >> grype-scan.json
            grype "$IMAGE_NAME" --name "$SCAN_NAME-$(basename $IMAGE_NAME)" --output table >> grype-scan.log || true
          done

      - name: Check Grype results and fail if vulnerabilities found
        if: ${{ always() && (inputs.fail-grype-on-high == true || inputs.fail-grype-on-critical == true) }}
        run: |
          JSON_FILE="grype-scan.json"
          
          if [ ! -f "$JSON_FILE" ]; then
            echo "⚠️  Grype JSON output not found"
            exit 0
          fi
          
          # Extract vulnerability counts by severity from multiple JSON documents
          # Use jq -s to slurp all JSON objects and combine matches
          CRITICAL_COUNT=$(jq -s '[.[] | .matches[]? | select(.vulnerability.severity == "Critical")] | length' "$JSON_FILE" 2>/dev/null || echo "0")
          HIGH_COUNT=$(jq -s '[.[] | .matches[]? | select(.vulnerability.severity == "High")] | length' "$JSON_FILE" 2>/dev/null || echo "0")
          
          echo ""
          echo "============================================"
          echo "Grype Security Scan Summary"
          echo "============================================"
          echo "CRITICAL vulnerabilities: $CRITICAL_COUNT"
          echo "HIGH vulnerabilities: $HIGH_COUNT"
          echo "============================================"
          
          VIOLATIONS=""
          [ "${{ inputs.fail-grype-on-critical }}" == "true" ] && [ "$CRITICAL_COUNT" -gt 0 ] && VIOLATIONS="${VIOLATIONS}$CRITICAL_COUNT CRITICAL, "
          [ "${{ inputs.fail-grype-on-high }}" == "true" ] && [ "$HIGH_COUNT" -gt 0 ] && VIOLATIONS="${VIOLATIONS}$HIGH_COUNT HIGH, "
          
          if [ -n "$VIOLATIONS" ]; then
            echo ""
            echo "❌ BUILD FAILED: Found ${VIOLATIONS%, }"
            exit 1
          else
            echo ""
            echo "✅ No policy-violating vulnerabilities found"
          fi

      - name: Upload Grype scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: grype-scan-results
          path: |
            grype-scan.json
            grype-scan.log
